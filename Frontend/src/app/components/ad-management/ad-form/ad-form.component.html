<div class="ad-form-container">
  <!-- Header -->
  <div class="form-header">
    <h2 mat-dialog-title>
      <mat-icon>{{ data.type === 'campaign' ? 'campaign' : 'ads_click' }}</mat-icon>
      {{ data.mode === 'create' ? 'Create' : 'Edit' }} {{ data.type === 'campaign' ? 'Campaign' : 'Ad' }}
    </h2>
    <button mat-icon-button (click)="cancel()" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Campaign Form -->
  @if (data.type === 'campaign') {
    <form [formGroup]="campaignForm" (ngSubmit)="submitForm()" class="campaign-form">
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>Campaign Information</mat-card-title>
          <mat-card-subtitle>Set up your advertising campaign</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Campaign Name</mat-label>
              <input matInput formControlName="name" placeholder="Enter campaign name">
              <mat-error *ngIf="campaignForm.get('name')?.hasError('required')">
                Campaign name is required
              </mat-error>
              <mat-error *ngIf="campaignForm.get('name')?.hasError('minlength')">
                Campaign name must be at least 3 characters
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Description</mat-label>
              <textarea matInput formControlName="description" 
                      placeholder="Describe your campaign goals and target audience"
                      rows="3"></textarea>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Status</mat-label>
              <mat-select formControlName="status">
                <mat-option *ngFor="let status of campaignStatuses" [value]="status.value">
                  {{ status.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Budget (USD)</mat-label>
              <input matInput type="number" formControlName="budget" 
                     placeholder="0.00" min="1" step="0.01">
              <mat-error *ngIf="campaignForm.get('budget')?.hasError('required')">
                Budget is required
              </mat-error>
              <mat-error *ngIf="campaignForm.get('budget')?.hasError('min')">
                Budget must be at least $1
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Start Date</mat-label>
              <input matInput [matDatepicker]="startPicker" formControlName="startDate">
              <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
              <mat-datepicker #startPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>End Date</mat-label>
              <input matInput [matDatepicker]="endPicker" formControlName="endDate">
              <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
              <mat-datepicker #endPicker></mat-datepicker>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Target Audience</mat-label>
              <input matInput formControlName="targetAudience" 
                     placeholder="Describe your target audience">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Keywords</mat-label>
              <mat-chip-grid #chipGrid aria-label="Keywords selection">
                <mat-chip-row *ngFor="let keyword of campaignForm.get('keywords')?.value" 
                              (removed)="removeKeyword(keyword)">
                  {{ keyword }}
                  <button matChipRemove [attr.aria-label]="'remove ' + keyword">
                    <mat-icon>cancel</mat-icon>
                  </button>
                </mat-chip-row>
              </mat-chip-grid>
              <input placeholder="Add keywords..." 
                     [matChipInputFor]="chipGrid"
                     [matChipInputSeparatorKeyCodes]="separatorKeysCodes"
                     (matChipInputTokenEnd)="addKeyword($event)">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-slide-toggle formControlName="isActive">
              Active Campaign
            </mat-slide-toggle>
          </div>
        </mat-card-content>
      </mat-card>
    </form>
  }

  <!-- Ad Form -->
  @if (data.type === 'ad') {
    <form [formGroup]="adForm" (ngSubmit)="submitForm()" class="ad-form">
      <mat-card class="form-card">
        <mat-card-header>
          <mat-card-title>Ad Information</mat-card-title>
          <mat-card-subtitle>Create your advertisement</mat-card-subtitle>
        </mat-card-header>
        
        <mat-card-content>
          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Campaign</mat-label>
              <mat-select formControlName="campaignId" (selectionChange)="onCampaignSelect($event.value)">
                <mat-option *ngFor="let campaign of campaigns" [value]="campaign.id">
                  {{ campaign.name }} ({{ campaign.status }})
                </mat-option>
              </mat-select>
              <mat-error *ngIf="adForm.get('campaignId')?.hasError('required')">
                Campaign is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Ad Type</mat-label>
              <mat-select formControlName="type" (selectionChange)="onAdTypeChange($event.value)">
                <mat-option *ngFor="let type of adTypes" [value]="type.value">
                  {{ type.label }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="adForm.get('type')?.hasError('required')">
                Ad type is required
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Position</mat-label>
              <mat-select formControlName="position">
                <mat-option *ngFor="let position of getFilteredPositions()" [value]="position.value">
                  {{ position.label }}
                </mat-option>
              </mat-select>
              <mat-error *ngIf="adForm.get('position')?.hasError('required')">
                Position is required
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Ad Content</mat-label>
              <textarea matInput formControlName="content" 
                        placeholder="Enter your ad content or headline"
                        rows="3"></textarea>
              <mat-error *ngIf="adForm.get('content')?.hasError('required')">
                Ad content is required
              </mat-error>
              <mat-error *ngIf="adForm.get('content')?.hasError('minlength')">
                Ad content must be at least 5 characters
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Target URL</mat-label>
              <input matInput formControlName="url" 
                     placeholder="https://example.com" 
                     type="url">
              <mat-error *ngIf="adForm.get('url')?.hasError('required')">
                Target URL is required
              </mat-error>
              <mat-error *ngIf="adForm.get('url')?.hasError('pattern')">
                Please enter a valid URL starting with http:// or https://
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Thumbnail URL</mat-label>
              <input matInput formControlName="thumbnailUrl" 
                     placeholder="https://example.com/image.jpg" 
                     type="url">
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Cost Per Click (USD)</mat-label>
              <input matInput type="number" formControlName="costPerClick" 
                     placeholder="0.01" min="0.01" step="0.01">
              <mat-error *ngIf="adForm.get('costPerClick')?.hasError('required')">
                Cost per click is required
              </mat-error>
              <mat-error *ngIf="adForm.get('costPerClick')?.hasError('min')">
                Cost per click must be at least $0.01
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Cost Per View (USD)</mat-label>
              <input matInput type="number" formControlName="costPerView" 
                     placeholder="0.01" min="0.01" step="0.01">
              <mat-error *ngIf="adForm.get('costPerView')?.hasError('required')">
                Cost per view is required
              </mat-error>
              <mat-error *ngIf="adForm.get('costPerView')?.hasError('min')">
                Cost per view must be at least $0.01
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Duration (seconds)</mat-label>
              <input matInput type="number" formControlName="duration" 
                     placeholder="30" min="5" max="300">
              <mat-error *ngIf="adForm.get('duration')?.hasError('required')">
                Duration is required
              </mat-error>
              <mat-error *ngIf="adForm.get('duration')?.hasError('min')">
                Duration must be at least 5 seconds
              </mat-error>
              <mat-error *ngIf="adForm.get('duration')?.hasError('max')">
                Duration must not exceed 300 seconds
              </mat-error>
            </mat-form-field>

            <mat-form-field appearance="outline" class="half-width">
              <mat-label>Skip After (seconds)</mat-label>
              <input matInput type="number" formControlName="skipAfter" 
                     placeholder="5" min="0">
              <mat-error *ngIf="adForm.get('skipAfter')?.hasError('required')">
                Skip after time is required
              </mat-error>
              <mat-error *ngIf="adForm.get('skipAfter')?.hasError('min')">
                Skip after time must be at least 0 seconds
              </mat-error>
            </mat-form-field>
          </div>

          <div class="form-row">
            <mat-slide-toggle formControlName="isActive">
              Active Ad
            </mat-slide-toggle>
          </div>
        </mat-card-content>
      </mat-card>

      <!-- Cost Estimation -->
      <mat-card class="cost-estimation-card">
        <mat-card-header>
          <mat-card-title>Cost Estimation</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="cost-breakdown">
            <div class="cost-item">
              <span class="cost-label">Estimated Cost:</span>
              <span class="cost-value">{{ formatCurrency(calculateEstimatedCost()) }}</span>
            </div>
            <div class="cost-details">
              <p>Cost per click: {{ formatCurrency(adForm.get('costPerClick')?.value || 0) }}</p>
              <p>Cost per view: {{ formatCurrency(adForm.get('costPerView')?.value || 0) }}</p>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </form>
  }

  <!-- Form Actions -->
  <div class="form-actions">
    <button mat-button type="button" (click)="cancel()" [disabled]="isSubmitting">
      Cancel
    </button>
    <button mat-raised-button color="primary" type="submit" 
            [disabled]="isSubmitting || (data.type === 'campaign' ? campaignForm.invalid : adForm.invalid)">
      @if (isSubmitting) {
        <mat-spinner diameter="20"></mat-spinner>
        <span>Saving...</span>
      } @else {
        <ng-container>
          <mat-icon>save</mat-icon>
          <span>{{ data.mode === 'create' ? 'Create' : 'Update' }}</span>
        </ng-container>
      }
    </button>
  </div>
</div>
