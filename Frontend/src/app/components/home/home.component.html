<div class="home-container">
  <!-- Header with Search and Navigation -->
  <div class="home-header">
    <div class="search-container">
      <div class="search-box">
        <input
          type="text"
          placeholder="Search videos, channels, and more..."
          class="search-input"
          [(ngModel)]="searchQuery"
          (keyup.enter)="onSearch()"
          (input)="onSearchInput($event)">
          <button class="search-btn" (click)="onSearch()">
            <mat-icon>search</mat-icon>
          </button>
        </div>
      </div>
    </div>

    <!-- Category Navigation -->
    <div class="category-nav">
      <div class="category-scroll">
        @for (category of categories; track category) {
          <button
            class="category-btn"
            [class.active]="selectedCategory === category"
            (click)="onCategoryChange(category)">
            {{ category }}
          </button>
        }
      </div>
    </div>

    <!-- Main Content -->
    <div class="main-content">
      <!-- Search Results Section -->
      @if (isSearchMode && searchResults.length > 0) {
        <section class="search-results-section">
          <h2 class="section-title">
            <mat-icon>search</mat-icon>
            Search Results for "{{ searchQuery }}"
          </h2>
          <div class="video-grid search-grid">
            @for (video of searchResults; track trackByVideoId($index, video)) {
              <div
                class="video-card search-card"
                (click)="onVideoClick(video)">
                <div class="video-thumbnail">
                  <img [src]="video.thumbnailUrl || '/assets/default-thumbnail.jpg'"
                    [alt]="video.title">
                    <div class="video-duration">{{ formatDuration(video.duration) }}</div>
                  </div>
                  <div class="video-info">
                    <h3 class="video-title">{{ video.title }}</h3>
                    <p class="video-channel" (click)="onChannelClick(video.channelId!)">
                      {{ video.channel?.name || (video.user?.firstName && video.user?.lastName ? (video.user?.firstName + ' ' + video.user?.lastName) : 'Unknown User') }}
                    </p>
                    <div class="video-stats">
                      <span>{{ video.viewCount | number }} views</span>
                      <span>{{ video.createdAt | date:'MMM d' }}</span>
                    </div>
                    @if (currentUser$ | async) {
                      <div class="video-actions">
                        <button mat-button color="primary" (click)="$event.stopPropagation(); toggleFavorite(video)">
                          <mat-icon>{{ video.isLiked ? 'favorite' : 'favorite_border' }}</mat-icon>
                          {{ video.isLiked ? 'Unfavorite' : 'Favorite' }}
                        </button>
                        <button mat-button (click)="$event.stopPropagation(); toggleSubscribe(video)">
                          <mat-icon>subscriptions</mat-icon>
                          {{ video.channel?.isSubscribed ? 'Unsubscribe' : 'Subscribe' }}
                        </button>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </section>
        }

        <!-- No Search Results -->
        @if (isSearchMode && searchResults.length === 0 && !isSearching) {
          <section class="no-results-section">
            <div class="no-results-container">
              <mat-icon class="no-results-icon">search_off</mat-icon>
              <h3>No results found</h3>
              <p>Try searching for something else or check your spelling.</p>
            </div>
          </section>
        }

        <!-- Search Loading -->
        @if (isSearching) {
          <section class="search-loading-section">
            <div class="loading-container">
              <mat-spinner diameter="50"></mat-spinner>
              <p>Searching...</p>
            </div>
          </section>
        }

      <!-- Trending Section -->
      @if (trendingVideos.length > 0) {
        <section class="trending-section">
          <h2 class="section-title">
            <mat-icon>trending_up</mat-icon>
            Trending Now
          </h2>
          <div class="video-grid trending-grid">
            @for (video of trendingVideos; track trackByVideoId($index, video)) {
              <div
                class="video-card trending-card"
                (click)="onVideoClick(video)">
                <div class="video-thumbnail">
                  <img [src]="video.thumbnailUrl || '/assets/default-thumbnail.jpg'"
                    [alt]="video.title">
                    <div class="video-duration">{{ formatDuration(video.duration) }}</div>
                  </div>
                  <div class="video-info">
                    <h3 class="video-title">{{ video.title }}</h3>
                    <p class="video-channel" (click)="onChannelClick(video.channelId!)">
                      {{ video.channel?.name || (video.user?.firstName && video.user?.lastName ? (video.user?.firstName + ' ' + video.user?.lastName) : 'Unknown User') }}
                    </p>
                    <div class="video-stats">
                      <span>{{ video.viewCount | number }} views</span>
                      <span>{{ video.createdAt | date:'MMM d' }}</span>
                    </div>
                    @if (currentUser$ | async) {
                      <div class="video-actions">
                        <button mat-button color="primary" (click)="$event.stopPropagation(); toggleFavorite(video)">
                          <mat-icon>{{ video.isLiked ? 'favorite' : 'favorite_border' }}</mat-icon>
                          {{ video.isLiked ? 'Unfavorite' : 'Favorite' }}
                        </button>
                        <button mat-button (click)="$event.stopPropagation(); toggleSubscribe(video)">
                          <mat-icon>subscriptions</mat-icon>
                          {{ video.channel?.isSubscribed ? 'Unsubscribe' : 'Subscribe' }}
                        </button>
                      </div>
                    }
                  </div>
                </div>
              }
            </div>
          </section>
        }

        <!-- Recommended Section -->
        @if ((currentUser$ | async) && recommendedVideos.length > 0) {
          <section class="recommended-section">
            <h2 class="section-title">
              <mat-icon>recommend</mat-icon>
              Recommended for you
            </h2>
            <div class="video-grid recommended-grid">
              @for (video of recommendedVideos; track trackByVideoId($index, video)) {
                <div
                  class="video-card recommended-card"
                  (click)="onVideoClick(video)">
                  <div class="video-thumbnail">
                    <img [src]="video.thumbnailUrl || '/assets/default-thumbnail.jpg'"
                      [alt]="video.title">
                      <div class="video-duration">{{ formatDuration(video.duration) }}</div>
                    </div>
                    <div class="video-info">
                      <h3 class="video-title">{{ video.title }}</h3>
                      <p class="video-channel" (click)="onChannelClick(video.channelId!)">
                        {{ video.channel?.name || (video.user?.firstName && video.user?.lastName ? (video.user?.firstName + ' ' + video.user?.lastName) : 'Unknown User') }}
                      </p>
                      <div class="video-stats">
                        <span>{{ video.viewCount | number }} views</span>
                        <span>{{ video.createdAt | date:'MMM d' }}</span>
                      </div>
                      @if (currentUser$ | async) {
                        <div class="video-actions">
                          <button mat-button color="primary" (click)="$event.stopPropagation(); toggleFavorite(video)">
                            <mat-icon>{{ video.isLiked ? 'favorite' : 'favorite_border' }}</mat-icon>
                            {{ video.isLiked ? 'Unfavorite' : 'Favorite' }}
                          </button>
                          <button mat-button (click)="$event.stopPropagation(); toggleSubscribe(video)">
                            <mat-icon>subscriptions</mat-icon>
                            {{ video.channel?.isSubscribed ? 'Unsubscribe' : 'Subscribe' }}
                          </button>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            </section>
          }

          <!-- Subscribed Section -->
          @if ((currentUser$ | async) && subscribedVideos.length > 0) {
            <section class="subscribed-section">
              <h2 class="section-title">
                <mat-icon>subscriptions</mat-icon>
                From your subscriptions
              </h2>
              <div class="video-grid subscribed-grid">
                @for (video of subscribedVideos; track trackByVideoId($index, video)) {
                  <div
                    class="video-card subscribed-card"
                    (click)="onVideoClick(video)">
                    <div class="video-thumbnail">
                      <img [src]="video.thumbnailUrl || '/assets/default-thumbnail.jpg'"
                        [alt]="video.title">
                        <div class="video-duration">{{ formatDuration(video.duration) }}</div>
                      </div>
                      <div class="video-info">
                        <h3 class="video-title">{{ video.title }}</h3>
                        <p class="video-channel" (click)="onChannelClick(video.channelId!)">
                          {{ video.channel?.name || video.user?.firstName + ' ' + video.user?.lastName }}
                        </p>
                        <div class="video-stats">
                          <span>{{ video.viewCount | number }} views</span>
                          <span>{{ video.createdAt | date:'MMM d' }}</span>
                        </div>
                        <div class="video-actions">
                          <button mat-button color="primary" (click)="$event.stopPropagation(); toggleFavorite(video)">
                            <mat-icon>{{ video.isLiked ? 'favorite' : 'favorite_border' }}</mat-icon>
                            {{ video.isLiked ? 'Unfavorite' : 'Favorite' }}
                          </button>
                          <button mat-button (click)="$event.stopPropagation(); toggleSubscribe(video)">
                            <mat-icon>subscriptions</mat-icon>
                            {{ video.channel?.isSubscribed ? 'Unsubscribe' : 'Subscribe' }}
                          </button>
                        </div>
                      </div>
                    </div>
                  }
                </div>
              </section>
            }

          <!-- Main Video Grid -->
          <section class="videos-section">
            @if (selectedCategory !== 'All') {
              <h2 class="section-title">
                {{ selectedCategory }} Videos
              </h2>
            }
            @if (selectedCategory === 'All') {
              <h2 class="section-title">
                Latest Videos
              </h2>
            }

            <!-- Loading State -->
            @if (loading$ | async) {
              <div class="loading-container">
                <mat-spinner diameter="50"></mat-spinner>
                <p>Loading videos...</p>
              </div>
            }

            <!-- Error State -->
            @if (error$ | async; as error) {
              <div class="error-container">
                <mat-icon class="error-icon">error_outline</mat-icon>
                <h3>Error loading videos</h3>
                <p>{{ error }}</p>
                <button class="retry-btn" (click)="loadInitialVideos()">
                  Try Again
                </button>
              </div>
            }

            <!-- Video Grid -->
            @if (!(loading$ | async) && !(error$ | async)) {
              <div class="video-grid main-grid">
                @for (video of videos$ | async; track trackByVideoId($index, video)) {
                  <div
                    class="video-card main-card"
                    (click)="onVideoClick(video)">
                    <div class="video-thumbnail">
                      <img [src]="video.thumbnailUrl || '/assets/default-thumbnail.jpg'"
                        [alt]="video.title">
                        <div class="video-duration">{{ formatDuration(video.duration) }}</div>
                        <div class="video-overlay">
                          <button class="play-btn">
                            <mat-icon>play_arrow</mat-icon>
                          </button>
                        </div>
                      </div>
                      <div class="video-info">
                        <div class="channel-avatar">
                          <img [src]="video.channel?.profilePictureUrl || video.user?.profilePictureUrl || '/assets/default-avatar.svg'"
                            [alt]="video.channel?.name || video.user?.firstName">
                          </div>
                          <div class="video-details">
                            <h3 class="video-title">{{ video.title }}</h3>
                            <p class="video-channel" (click)="onChannelClick(video.channelId!)">
                              {{ video.channel?.name || (video.user?.firstName && video.user?.lastName ? (video.user?.firstName + ' ' + video.user?.lastName) : 'Unknown User') }}
                            </p>
                            <div class="video-stats">
                              <span>{{ video.viewCount | number }} views</span>
                              <span>{{ video.createdAt | date:'MMM d' }}</span>
                            </div>
                            @if (currentUser$ | async) {
                              <div class="video-actions">
                                <button mat-button color="primary" (click)="$event.stopPropagation(); toggleFavorite(video)">
                                  <mat-icon>{{ video.isLiked ? 'favorite' : 'favorite_border' }}</mat-icon>
                                  {{ video.isLiked ? 'Unfavorite' : 'Favorite' }}
                                </button>
                                <button mat-button (click)="$event.stopPropagation(); toggleSubscribe(video)">
                                  <mat-icon>subscriptions</mat-icon>
                                  {{ video.channel?.isSubscribed ? 'Unsubscribe' : 'Subscribe' }}
                                </button>
                              </div>
                            }
                          </div>
                        </div>
                      </div>
                    }
                  </div>
                }

                <!-- Load More Button -->
                @if (!(loading$ | async) && !(error$ | async)) {
                  <div class="load-more-container">
                    <button class="load-more-btn" (click)="loadMoreVideos()">
                      Load More Videos
                    </button>
                  </div>
                }
              </section>
            </div>
          </div>
